---
phase: 14-settings-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - src/setupTests.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "npm test runs Vitest successfully"
    - "Tests can import React components and run in jsdom environment"
    - "Test files are discovered with *.test.ts and *.test.tsx patterns"
  artifacts:
    - path: "src/setupTests.ts"
      provides: "Test setup with jest-dom matchers"
      contains: "@testing-library/jest-dom"
    - path: "vite.config.ts"
      provides: "Vitest configuration"
      contains: "test:"
    - path: "package.json"
      provides: "Test scripts"
      contains: "vitest"
  key_links:
    - from: "vite.config.ts"
      to: "src/setupTests.ts"
      via: "setupFiles config"
      pattern: "setupFiles.*setupTests"
---

<objective>
Set up Vitest testing infrastructure with React Testing Library for the project.

Purpose: Enable automated testing to satisfy SETT-03 and provide foundation for future tests.
Output: Working test runner with `npm test` command.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-settings-audit/14-RESEARCH.md

@vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install testing dependencies</name>
  <files>package.json</files>
  <action>
    Install Vitest and React Testing Library dependencies:

    ```bash
    npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom @vitest/coverage-v8
    ```

    These packages provide:
    - vitest: Test runner with native Vite integration
    - @testing-library/react: React component testing utilities
    - @testing-library/jest-dom: Custom DOM matchers (toBeInTheDocument, etc.)
    - @testing-library/user-event: User interaction simulation
    - jsdom: DOM environment for tests
    - @vitest/coverage-v8: Code coverage reporting
  </action>
  <verify>
    - `npm ls vitest` shows vitest installed
    - `npm ls @testing-library/react` shows testing-library installed
    - package.json has these in devDependencies
  </verify>
  <done>Testing dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest in vite.config.ts</name>
  <files>vite.config.ts</files>
  <action>
    Add Vitest configuration to vite.config.ts:

    1. Add type reference at the top:
       ```typescript
       /// <reference types="vitest" />
       ```

    2. Add test configuration inside the returned config object (after the `build` section):
       ```typescript
       test: {
         globals: true,
         environment: 'jsdom',
         setupFiles: './src/setupTests.ts',
         include: ['**/*.{test,spec}.{ts,tsx}'],
         exclude: ['node_modules', 'dist'],
         coverage: {
           provider: 'v8',
           reporter: ['text', 'html'],
           include: ['services/**', 'components/StoreContext.tsx', 'lib/**'],
           exclude: ['**/*.d.ts', '**/*.test.{ts,tsx}']
         }
       }
       ```

    Note: The config is inside defineConfig's return value, so add it at the same level as `server`, `plugins`, `build`, etc.
  </action>
  <verify>
    - `grep "test:" vite.config.ts` shows test config exists
    - `grep "jsdom" vite.config.ts` shows jsdom environment
    - `npm run build` still works (config is valid)
  </verify>
  <done>Vitest configured in vite.config.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create test setup file and npm scripts</name>
  <files>src/setupTests.ts, package.json</files>
  <action>
    1. Create `src/setupTests.ts`:
       ```typescript
       import '@testing-library/jest-dom';
       import { cleanup } from '@testing-library/react';
       import { afterEach, vi } from 'vitest';

       // Clean up after each test
       afterEach(() => {
         cleanup();
       });

       // Mock ResizeObserver (not available in jsdom)
       global.ResizeObserver = vi.fn().mockImplementation(() => ({
         observe: vi.fn(),
         unobserve: vi.fn(),
         disconnect: vi.fn(),
       }));

       // Mock matchMedia (not available in jsdom)
       Object.defineProperty(window, 'matchMedia', {
         writable: true,
         value: vi.fn().mockImplementation((query: string) => ({
           matches: false,
           media: query,
           onchange: null,
           addListener: vi.fn(),
           removeListener: vi.fn(),
           addEventListener: vi.fn(),
           removeEventListener: vi.fn(),
           dispatchEvent: vi.fn(),
         })),
       });
       ```

    2. Add test scripts to package.json:
       Open package.json and add these to the "scripts" section:
       ```json
       "test": "vitest",
       "test:run": "vitest run",
       "test:coverage": "vitest run --coverage"
       ```

    Note: The ResizeObserver and matchMedia mocks are needed because Radix UI components use these APIs which jsdom doesn't provide.
  </action>
  <verify>
    - `src/setupTests.ts` exists
    - `npm test -- --run` runs without errors (even with no tests, should just say 0 tests)
    - `grep '"test":' package.json` shows test script
  </verify>
  <done>Test setup file and npm scripts created</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` executes successfully (exits with 0, reports 0 tests or similar)
2. `src/setupTests.ts` exists with jest-dom import and cleanup
3. `vite.config.ts` has test configuration with jsdom environment
4. `package.json` has test, test:run, and test:coverage scripts
5. `npm run build` still works (no regressions)
</verification>

<success_criteria>
- Vitest is properly configured and runs via `npm test`
- Test environment supports React components (jsdom)
- jest-dom matchers are available in tests
- ResizeObserver and matchMedia are mocked (Radix UI compatibility)
- Coverage reporting is configured
- Project still builds correctly
</success_criteria>

<output>
After completion, create `.planning/phases/14-settings-audit/14-02-SUMMARY.md`
</output>
