---
phase: 14-settings-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/StoreContext.tsx
  - pages/StudySession.tsx
  - lib/constants.ts
autonomous: true

must_haves:
  truths:
    - "New study cards use book-specific ease factor when set"
    - "New study cards use global default ease factor when book has no override"
    - "StudySession shows correct daily limit message based on actual book limit"
    - "Magic numbers are replaced with named constants"
  artifacts:
    - path: "lib/constants.ts"
      provides: "Named constants for default values"
      contains: "DEFAULT_DAILY_LIMIT"
    - path: "components/StoreContext.tsx"
      provides: "Fixed bulkAddToStudy using settings cascade"
      pattern: "book\\.settings\\?.initialEaseFactor"
    - path: "pages/StudySession.tsx"
      provides: "Fixed daily limit check using actual limit"
      pattern: "dailyLimit.*settings\\.maxReviewsPerDay"
  key_links:
    - from: "components/StoreContext.tsx"
      to: "lib/constants.ts"
      via: "import"
      pattern: "import.*constants"
    - from: "pages/StudySession.tsx"
      to: "components/StoreContext.tsx"
      via: "useStore hook"
      pattern: "settings\\.maxReviewsPerDay"
---

<objective>
Fix settings bugs: bulkAddToStudy ease factor, StudySession daily limit check, and extract magic numbers to constants.

Purpose: Ensure Study Options settings actually apply correctly to study sessions (SETT-01, SETT-02).
Output: Settings cascade works correctly for all card creation and limit checks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-settings-audit/14-RESEARCH.md

@components/StoreContext.tsx
@pages/StudySession.tsx
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create constants file and fix magic numbers</name>
  <files>lib/constants.ts, components/StoreContext.tsx</files>
  <action>
    1. Create `lib/constants.ts` with:
       ```typescript
       // Study defaults
       export const DEFAULT_DAILY_LIMIT = 10;
       export const DEFAULT_EASE_FACTOR = 2.5;
       export const MIN_EASE_FACTOR = 1.3;
       export const MAX_EASE_FACTOR = 2.5;
       ```

    2. In `components/StoreContext.tsx`:
       - Add import: `import { DEFAULT_DAILY_LIMIT, DEFAULT_EASE_FACTOR } from '../lib/constants';`
       - Replace all hard-coded `10` for daily limits with `DEFAULT_DAILY_LIMIT`
       - Replace all hard-coded `2.5` for ease factor with `DEFAULT_EASE_FACTOR`

    Search for these patterns and replace:
    - `|| 10` -> `|| DEFAULT_DAILY_LIMIT`
    - `easeFactor: 2.5` -> `easeFactor: DEFAULT_EASE_FACTOR`
    - But NOT in sm2.ts (that's algorithm code, leave it)
  </action>
  <verify>
    - `lib/constants.ts` exists with 4 constants
    - `grep "import.*constants" components/StoreContext.tsx` shows import
    - `grep "DEFAULT_DAILY_LIMIT\|DEFAULT_EASE_FACTOR" components/StoreContext.tsx` shows usage
    - `npm run build` succeeds (no type errors)
  </verify>
  <done>Magic numbers replaced with named constants in StoreContext.tsx</done>
</task>

<task type="auto">
  <name>Task 2: Fix bulkAddToStudy to use settings cascade</name>
  <files>components/StoreContext.tsx</files>
  <action>
    In `bulkAddToStudy` function (around line 785-831):

    Current code creates cards with hard-coded ease factor:
    ```typescript
    newCards.push({
      id: generateUUID(),
      highlightId,
      easeFactor: 2.5,  // WRONG: ignores settings
      ...
    });
    ```

    Fix to respect settings cascade (book > global > default):
    ```typescript
    highlightIds.forEach(highlightId => {
      if (!existingHighlightIds.has(highlightId)) {
        // Find the highlight's book to get its settings
        const highlight = highlights.find(h => h.id === highlightId);
        const book = highlight ? books.find(b => b.id === highlight.bookId) : null;

        // Settings cascade: book override > global > default
        const initialEaseFactor = book?.settings?.initialEaseFactor
          || settings.defaultInitialEaseFactor
          || DEFAULT_EASE_FACTOR;

        newCards.push({
          id: generateUUID(),
          highlightId,
          easeFactor: initialEaseFactor,
          interval: 0,
          repetitions: 0,
          nextReviewDate: new Date().toISOString()
        });
      }
    });
    ```

    Note: `highlights` and `books` are already in scope from the component state.
  </action>
  <verify>
    - `grep -A 15 "bulkAddToStudy" components/StoreContext.tsx` shows book settings lookup
    - `grep "initialEaseFactor" components/StoreContext.tsx` shows cascade logic in bulkAddToStudy
    - `npm run build` succeeds
  </verify>
  <done>bulkAddToStudy respects book-specific and global ease factor settings</done>
</task>

<task type="auto">
  <name>Task 3: Fix StudySession daily limit check</name>
  <files>pages/StudySession.tsx</files>
  <action>
    In `StudySession.tsx` around line 283:

    Current code has hard-coded limit:
    ```typescript
    const isDailyLimitReached = deckId && reviewsToday >= 10;
    ```

    Fix to use actual book/global limit:
    ```typescript
    // Get actual daily limit for this deck
    const book = deckId ? books.find(b => b.id === deckId) : null;
    const dailyLimit = book?.settings?.dailyReviewLimit || settings.maxReviewsPerDay || DEFAULT_DAILY_LIMIT;
    const isDailyLimitReached = deckId && reviewsToday >= dailyLimit;
    ```

    Need to:
    1. Import `DEFAULT_DAILY_LIMIT` from `../lib/constants`
    2. Ensure `books` and `settings` are available from useStore (they should already be destructured)
    3. Add the book lookup and limit calculation before the check

    Check the existing destructuring from useStore at the top of the component - add `books` and `settings` if not already there.
  </action>
  <verify>
    - `grep "dailyLimit" pages/StudySession.tsx` shows limit calculation
    - `grep "settings.maxReviewsPerDay" pages/StudySession.tsx` shows settings usage
    - `npm run build` succeeds
    - Manual test: Set a book's daily limit to 2, do 2 reviews, verify "daily limit reached" message appears
  </verify>
  <done>StudySession respects per-book and global daily limits for the limit reached message</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. `lib/constants.ts` exists with DEFAULT_DAILY_LIMIT and DEFAULT_EASE_FACTOR
3. No hard-coded `10` for limits or `2.5` for ease factor in StoreContext.tsx (except sm2.ts)
4. bulkAddToStudy uses settings cascade for ease factor
5. StudySession uses actual limit for daily limit check
</verification>

<success_criteria>
- Settings cascade works: book override > global setting > default constant
- bulkAddToStudy creates cards with correct ease factor based on settings
- StudySession shows correct "daily limit reached" based on actual configured limit
- No magic numbers in business logic (all use named constants)
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-settings-audit/14-01-SUMMARY.md`
</output>
