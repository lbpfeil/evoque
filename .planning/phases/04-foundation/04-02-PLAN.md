---
phase: 04-foundation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - i18n/config.ts
  - i18n/index.ts
  - components/I18nProvider.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "i18next initializes with PT-BR as default language"
    - "I18nProvider renders in component tree without errors"
    - "useTranslation hook works and returns translated strings"
    - "Language detector reads from localStorage"
  artifacts:
    - path: "i18n/config.ts"
      provides: "i18next configuration"
      exports: ["i18nConfig"]
      min_lines: 20
    - path: "i18n/index.ts"
      provides: "i18next initialization"
      exports: ["default"]
      min_lines: 15
    - path: "components/I18nProvider.tsx"
      provides: "React provider wrapper for i18n"
      exports: ["I18nProvider"]
      min_lines: 10
    - path: "App.tsx"
      provides: "Root component with I18nProvider integrated"
      contains: "I18nProvider"
  key_links:
    - from: "i18n/index.ts"
      to: "i18n/config.ts"
      via: "import"
      pattern: "import.*config"
    - from: "components/I18nProvider.tsx"
      to: "i18n/index.ts"
      via: "import"
      pattern: "import.*i18n"
    - from: "App.tsx"
      to: "components/I18nProvider.tsx"
      via: "component tree"
      pattern: "<I18nProvider>"
---

<objective>
Configure i18next, create the I18nProvider component, and integrate it into App.tsx below AuthProvider.

Purpose: Complete the i18n infrastructure so that components can use the useTranslation hook to access translations.

Output: Working i18n setup where `t('common:test')` returns "Tradução funcionando!" in any component.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/phases/04-foundation/04-01-SUMMARY.md
@App.tsx
@components/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create i18n configuration and initialization</name>
  <files>
i18n/config.ts
i18n/index.ts
  </files>
  <action>
Create the `i18n/` directory at project root (same level as `components/`, `pages/`).

**i18n/config.ts** - Configuration object:
```typescript
export const i18nConfig = {
  // Supported languages
  supportedLngs: ['pt-BR', 'en'],

  // Default language (PT-BR as per requirements)
  fallbackLng: 'pt-BR',

  // Default namespace
  defaultNS: 'common',

  // Namespaces to load
  ns: ['common', 'auth', 'highlights', 'study', 'session', 'settings', 'dashboard', 'errors'],

  // Language detection order
  detection: {
    // Order of detection: localStorage first, then browser
    order: ['localStorage', 'navigator'],
    // Key for localStorage
    lookupLocalStorage: 'evoque-language',
    // Cache user language in localStorage
    caches: ['localStorage'],
  },

  // HTTP backend configuration (load from public/locales)
  backend: {
    loadPath: '/locales/{{lng}}/{{ns}}.json',
  },

  // React specific options
  react: {
    useSuspense: true,
  },

  // Interpolation settings
  interpolation: {
    escapeValue: false, // React already escapes
  },
};
```

**i18n/index.ts** - Initialization:
```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import HttpBackend from 'i18next-http-backend';
import { i18nConfig } from './config';

i18n
  .use(HttpBackend)
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    ...i18nConfig,
    debug: import.meta.env.DEV, // Enable debug in dev mode only
  });

export default i18n;
```

Key decisions:
- Use HTTP backend (not bundled) for lazy loading support
- localStorage key is 'evoque-language' (consistent with 'evoque-theme')
- Suspense enabled (React 19 compatible)
- Debug only in dev mode
  </action>
  <verify>
Files exist at i18n/config.ts and i18n/index.ts.
TypeScript compiles without errors: `npx tsc --noEmit i18n/*.ts` (or run full build).
  </verify>
  <done>
i18n/config.ts exports i18nConfig with PT-BR default and 8 namespaces.
i18n/index.ts initializes i18next with all plugins.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create I18nProvider component</name>
  <files>components/I18nProvider.tsx</files>
  <action>
Create `components/I18nProvider.tsx`:

```typescript
import React, { Suspense } from 'react';
import { I18nextProvider } from 'react-i18next';
import i18n from '../i18n';
import { Loader2 } from 'lucide-react';

// Loading fallback while translations load
const I18nLoadingFallback = () => (
  <div className="min-h-screen flex items-center justify-center bg-background">
    <div className="text-center">
      <Loader2 className="w-8 h-8 text-primary animate-spin mx-auto mb-2" />
      <p className="text-xs text-muted-foreground">Carregando idioma...</p>
    </div>
  </div>
);

interface I18nProviderProps {
  children: React.ReactNode;
}

export const I18nProvider: React.FC<I18nProviderProps> = ({ children }) => {
  return (
    <I18nextProvider i18n={i18n}>
      <Suspense fallback={<I18nLoadingFallback />}>
        {children}
      </Suspense>
    </I18nextProvider>
  );
};
```

Key decisions:
- Wrap children in Suspense for async translation loading
- Loading fallback matches existing app loading style (Loader2 icon)
- Hardcoded Portuguese in fallback is intentional (translations not loaded yet)
- Simple wrapper, no complex state management needed
  </action>
  <verify>
File exists at components/I18nProvider.tsx.
Exports I18nProvider component.
No TypeScript errors.
  </verify>
  <done>
I18nProvider.tsx exports a React component that wraps children with I18nextProvider and Suspense.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate I18nProvider into App.tsx</name>
  <files>App.tsx</files>
  <action>
Modify App.tsx to add I18nProvider in the component tree.

**Target position (from research):**
```
ErrorBoundary
  ThemeProvider
    AuthProvider
      I18nProvider  <-- INSERT HERE
        ProtectedApp
```

Changes to make:
1. Add import: `import { I18nProvider } from './components/I18nProvider';`
2. Wrap ProtectedApp with I18nProvider inside AuthProvider

**Before:**
```tsx
const App = () => {
  return (
    <ErrorBoundary>
      <ThemeProvider defaultTheme="system" storageKey="evoque-theme">
        <AuthProvider>
          <ProtectedApp />
          <SpeedInsights />
        </AuthProvider>
      </ThemeProvider>
    </ErrorBoundary>
  );
};
```

**After:**
```tsx
const App = () => {
  return (
    <ErrorBoundary>
      <ThemeProvider defaultTheme="system" storageKey="evoque-theme">
        <AuthProvider>
          <I18nProvider>
            <ProtectedApp />
          </I18nProvider>
          <SpeedInsights />
        </AuthProvider>
      </ThemeProvider>
    </ErrorBoundary>
  );
};
```

Important: Keep SpeedInsights outside I18nProvider (it doesn't need translations).

Also, add a test translation call in the ProtectedApp loading state to verify i18n works:
1. Import useTranslation: `import { useTranslation } from 'react-i18next';`
2. In ProtectedApp loading div, use: `<p className="text-sm text-muted-foreground">{t('common:loading')}</p>`

This serves as verification that the setup works end-to-end.
  </action>
  <verify>
Run `npm run dev` and verify:
1. App loads without errors
2. No console errors related to i18n
3. Check browser DevTools Network tab: locales/pt-BR/common.json is fetched
4. Check localStorage: 'evoque-language' key exists with 'pt-BR' value
  </verify>
  <done>
App.tsx imports I18nProvider and wraps ProtectedApp.
App loads successfully with i18n initialized.
PT-BR translation files are fetched from public/locales/.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. Browser console shows no i18n-related errors
3. DevTools Network tab shows requests to `/locales/pt-BR/*.json`
4. localStorage contains `evoque-language: "pt-BR"`
5. (Optional) Add temporary `console.log(t('common:test'))` to verify translation returns "Tradução funcionando!"
</verification>

<success_criteria>
- i18n/config.ts and i18n/index.ts exist with proper configuration
- components/I18nProvider.tsx exports working provider component
- App.tsx has I18nProvider in correct position (below AuthProvider)
- App loads without errors
- i18next initializes with PT-BR as default
- Translation files are loaded from public/locales/pt-BR/
- useTranslation hook is accessible from any component
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-02-SUMMARY.md`
</output>
