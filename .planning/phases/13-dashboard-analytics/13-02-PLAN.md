---
phase: 13-dashboard-analytics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/Dashboard.tsx
  - public/locales/pt-BR/dashboard.json
autonomous: true

must_haves:
  truths:
    - "Dashboard page renders with KPI cards"
    - "Quick study button is visible and prominent"
    - "Heatmap displays review activity"
    - "Top books section shows ranking of most reviewed books"
  artifacts:
    - path: "pages/Dashboard.tsx"
      provides: "Dashboard page component"
      min_lines: 150
    - path: "public/locales/pt-BR/dashboard.json"
      provides: "Portuguese translations for Dashboard"
      contains: "kpi"
  key_links:
    - from: "pages/Dashboard.tsx"
      to: "components/StoreContext.tsx"
      via: "useStore hook"
      pattern: "useStore\\(\\)"
    - from: "pages/Dashboard.tsx"
      to: "components/StudyHeatmap.tsx"
      via: "StudyHeatmap component"
      pattern: "<StudyHeatmap"
---

<objective>
Create Dashboard page with KPIs, Quick Study button, Heatmap, and Top Books chart.

Purpose: Provide users with an overview of their study progress and quick access to start studying.
Output: Complete Dashboard.tsx page with all analytics sections and Portuguese translations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dashboard-analytics/13-RESEARCH.md

@components/StoreContext.tsx
@components/StudyHeatmap.tsx
@pages/Study.tsx
@public/locales/pt-BR/common.json
@lbp_diretrizes/design-system-guide.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dashboard page</name>
  <files>pages/Dashboard.tsx</files>
  <action>
Create new Dashboard.tsx page with the following structure:

1. **Imports:**
   - React hooks: useState, useMemo
   - react-router-dom: useNavigate
   - react-i18next: useTranslation
   - StoreContext: useStore
   - StudyHeatmap component
   - Recharts: BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer
   - lucide-react icons: Target, Flame, Clock, BookOpen, TrendingUp, LayoutDashboard
   - Button from components/ui/button
   - Card, CardHeader, CardTitle, CardContent from components/ui/card

2. **StatCard Component (inline):**
```tsx
interface StatCardProps {
  title: string;
  value: string | number;
  icon: React.ElementType;
  subtitle?: string;
}

const StatCard = ({ title, value, icon: Icon, subtitle }: StatCardProps) => (
  <Card className="hover:border-primary/30 transition-colors duration-200">
    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
      <CardTitle className="text-overline font-medium uppercase tracking-wider text-muted-foreground">
        {title}
      </CardTitle>
      <Icon className="w-5 h-5 text-muted-foreground" />
    </CardHeader>
    <CardContent>
      <p className="text-2xl font-bold tracking-tight">{value}</p>
      {subtitle && <p className="text-caption text-muted-foreground mt-1">{subtitle}</p>}
    </CardContent>
  </Card>
);
```

3. **QuickStudyButton Component (inline):**
```tsx
interface QuickStudyButtonProps {
  cardsDue: number;
  onClick: () => void;
}

const QuickStudyButton = ({ cardsDue, onClick }: QuickStudyButtonProps) => (
  <Card className="bg-primary text-primary-foreground border-primary">
    <CardContent className="p-md">
      <div className="flex items-center justify-between">
        <div>
          <p className="text-body font-semibold">{t('quickStudy.title')}</p>
          <p className="text-caption opacity-80">
            {cardsDue > 0
              ? t('quickStudy.cardsDue', { count: cardsDue })
              : t('quickStudy.noCards')}
          </p>
        </div>
        <Button
          variant="secondary"
          onClick={onClick}
          disabled={cardsDue === 0}
          className="min-w-[100px]"
        >
          {t('quickStudy.button')}
        </Button>
      </div>
    </CardContent>
  </Card>
);
```

4. **Analytics Calculations (useMemo):**
```tsx
const analytics = useMemo(() => {
  // Format local date helper
  const formatLocalDate = (date: Date): string => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  const now = new Date();
  const today = formatLocalDate(now);

  // Reviews today
  const reviewsToday = reviewLogs.filter(
    log => formatLocalDate(new Date(log.reviewedAt)) === today
  ).length;

  // Average time (only logs with duration data)
  const logsWithDuration = reviewLogs.filter(log => log.durationMs != null);
  const avgTimeMs = logsWithDuration.length > 0
    ? logsWithDuration.reduce((sum, log) => sum + log.durationMs!, 0) / logsWithDuration.length
    : null;
  const avgTimeSeconds = avgTimeMs ? Math.round(avgTimeMs / 1000) : null;

  // Current streak (reuse logic from heatmap)
  // ... (calculate from reviewLogs)

  // Most reviewed books
  const bookReviewCounts = new Map<string, number>();
  for (const log of reviewLogs) {
    const card = studyCards.find(c => c.id === log.cardId);
    if (!card) continue;
    const highlight = highlights.find(h => h.id === card.highlightId);
    if (!highlight) continue;
    bookReviewCounts.set(
      highlight.bookId,
      (bookReviewCounts.get(highlight.bookId) || 0) + 1
    );
  }

  const topBooks = Array.from(bookReviewCounts.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([bookId, count]) => {
      const book = books.find(b => b.id === bookId);
      return {
        name: book ? (book.title.length > 25 ? book.title.slice(0, 25) + '...' : book.title) : 'Unknown',
        reviews: count
      };
    });

  return { reviewsToday, avgTimeSeconds, topBooks };
}, [reviewLogs, studyCards, highlights, books]);
```

5. **Page Layout (Pattern A from design guide):**
```tsx
<div className="space-y-xl max-w-4xl">
  {/* Quick Study CTA */}
  <QuickStudyButton cardsDue={cardsDue} onClick={() => navigate('/study')} />

  {/* KPI Grid - 2 cols mobile, 4 cols desktop */}
  <div className="grid grid-cols-2 sm:grid-cols-4 gap-sm">
    <StatCard
      title={t('kpi.cardsDue')}
      value={cardsDue}
      icon={Target}
    />
    <StatCard
      title={t('kpi.reviewsToday')}
      value={analytics.reviewsToday}
      icon={TrendingUp}
    />
    <StatCard
      title={t('kpi.avgTime')}
      value={analytics.avgTimeSeconds ? `${analytics.avgTimeSeconds}s` : '-'}
      icon={Clock}
      subtitle={analytics.avgTimeSeconds ? t('kpi.perCard') : t('kpi.noData')}
    />
    <StatCard
      title={t('kpi.totalBooks')}
      value={books.length}
      icon={BookOpen}
    />
  </div>

  {/* Heatmap Section */}
  <section>
    <StudyHeatmap reviewLogs={reviewLogs} />
  </section>

  {/* Top Books Section */}
  {analytics.topBooks.length > 0 && (
    <section>
      <h2 className="text-body font-semibold text-foreground mb-md">{t('topBooks.title')}</h2>
      <Card>
        <CardContent className="p-md">
          <ResponsiveContainer width="100%" height={200}>
            <BarChart data={analytics.topBooks} layout="vertical">
              <XAxis type="number" />
              <YAxis
                type="category"
                dataKey="name"
                width={150}
                tick={{ fontSize: 12 }}
              />
              <Tooltip />
              <Bar
                dataKey="reviews"
                fill="hsl(var(--primary))"
                radius={[0, 4, 4, 0]}
              />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>
    </section>
  )}
</div>
```

Key implementation notes:
- Use `useTranslation('dashboard')` for translations
- Get cardsDue from `getCardsDue().length`
- Use existing StudyHeatmap component for activity visualization
- Use Recharts (already installed) for Top Books chart
- Follow design system spacing: gap-sm, p-md, mb-md, space-y-xl
- Responsive grid: 2 cols on mobile, 4 on desktop for KPIs
  </action>
  <verify>File exists and TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Dashboard.tsx renders with QuickStudyButton, 4 KPI StatCards, Heatmap, and TopBooks chart</done>
</task>

<task type="auto">
  <name>Task 2: Update Dashboard translations</name>
  <files>public/locales/pt-BR/dashboard.json</files>
  <action>
Update existing dashboard.json file by merging new keys with existing ones.

The file already contains: stats, recentBooks, charts sections.
Add new keys for Phase 13 features while preserving existing keys.

Final merged structure:

```json
{
  "_meta": "Dashboard page strings (stats, charts, recent books, KPIs)",
  "title": "Dashboard",
  "subtitle": "Visão geral do seu progresso de leitura e aprendizado",
  "stats": {
    "books": "Livros",
    "highlights": "Destaques",
    "toReview": "Para Revisar",
    "streak": "Sequência",
    "streakValue": "{{count}} dias",
    "streakValue_one": "{{count}} dia"
  },
  "recentBooks": {
    "title": "Livros Recentes",
    "highlightsCount": "{{count}} destaques",
    "highlightsCount_one": "{{count}} destaque"
  },
  "charts": {
    "importActivity": "Atividade de Importação",
    "highlightsPerBook": "Destaques por Livro"
  },
  "quickStudy": {
    "title": "Pronto para estudar?",
    "cardsDue": "{{count}} cards para revisar",
    "cardsDue_one": "{{count}} card para revisar",
    "noCards": "Nenhum card para revisar hoje",
    "button": "Estudar"
  },
  "kpi": {
    "cardsDue": "Cards Pendentes",
    "reviewsToday": "Revisados Hoje",
    "avgTime": "Tempo Médio",
    "totalBooks": "Livros",
    "perCard": "por card",
    "noData": "sem dados"
  },
  "topBooks": {
    "title": "Livros Mais Revisados"
  },
  "empty": {
    "title": "Bem-vindo ao Evoque!",
    "message": "Importe seus highlights do Kindle para começar a estudar.",
    "importButton": "Importar Highlights"
  }
}
```

Note: This MERGES new keys with existing file content. Do NOT overwrite existing keys.
  </action>
  <verify>JSON is valid: `type public\locales\pt-BR\dashboard.json | python -m json.tool`</verify>
  <done>dashboard.json contains both existing and new translation keys</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dashboard.tsx exists with all sections
3. Translations file is valid JSON with merged keys
4. No import errors in Dashboard.tsx
Note: Task 3 removed — dashboard namespace already registered in i18n/config.ts line 12
</verification>

<success_criteria>
- Dashboard page has QuickStudyButton component
- Dashboard displays 4 KPI cards (Cards Due, Reviews Today, Avg Time, Total Books)
- StudyHeatmap is rendered on Dashboard
- Top Books chart shows using Recharts BarChart
- All text uses i18n translations
</success_criteria>

<output>
After completion, create `.planning/phases/13-dashboard-analytics/13-02-SUMMARY.md`
</output>
