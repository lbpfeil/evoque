---
phase: 13-dashboard-analytics
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - pages/StudySession.tsx
  - components/StoreContext.tsx
autonomous: true

must_haves:
  truths:
    - "Card show time is tracked when card is displayed"
    - "Duration is calculated when user rates card"
    - "Duration in milliseconds is saved to review_logs"
  artifacts:
    - path: "pages/StudySession.tsx"
      provides: "Time tracking state and calculation"
      contains: "cardShowTime"
    - path: "components/StoreContext.tsx"
      provides: "submitReview accepts durationMs parameter"
      contains: "durationMs"
  key_links:
    - from: "pages/StudySession.tsx"
      to: "components/StoreContext.tsx"
      via: "submitReview call with duration"
      pattern: "submitReview.*durationMs"
    - from: "components/StoreContext.tsx"
      to: "lib/supabaseHelpers.ts"
      via: "toSupabaseReviewLog with duration"
      pattern: "toSupabaseReviewLog.*durationMs"
---

<objective>
Implement time tracking in StudySession to measure how long users spend on each card.

Purpose: Enable analytics on review time per card, allowing users to see average response times on the Dashboard.
Output: StudySession tracks card display time, calculates duration, and passes it to submitReview for storage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dashboard-analytics/13-RESEARCH.md
@.planning/phases/13-dashboard-analytics/13-01-SUMMARY.md

@pages/StudySession.tsx
@components/StoreContext.tsx
@types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add time tracking state to StudySession</name>
  <files>pages/StudySession.tsx</files>
  <action>
Add time tracking to StudySession.tsx:

1. **Add state for card show time** (after line ~56, with other useState declarations):
```typescript
const [cardShowTime, setCardShowTime] = useState<number>(Date.now());
```

2. **Reset timer when card changes** - modify the existing useEffect that resets showAnswer (around line 89-93):
```typescript
// Reset showAnswer and timer when card changes (prevents flashing next card's answer)
useEffect(() => {
    setShowAnswer(false);
    setIsEditingHighlight(false);
    setIsEditingNote(false);
    setCardShowTime(Date.now());  // NEW: Reset timer for new card
}, [currentCardId]);
```

3. **Calculate and pass duration in handleResponse** (around line 95-126):
Modify the handleResponse function to calculate duration and pass it to submitReview:

```typescript
const handleResponse = useCallback(async (quality: number) => {
    // Prevent double-click / duplicate submissions
    if (!currentCard || isSubmittingResponse) return;

    setIsSubmittingResponse(true);

    // Calculate duration for this card
    const durationMs = Date.now() - cardShowTime;  // NEW

    // Save previous state BEFORE updating
    const previousCard = { ...currentCard };

    // 1. Calculate next review (SM-2 Algorithm) - local operation
    const updatedCard = calculateNextReview(currentCard, quality);

    // 2. Fire both operations in parallel (don't await)
    // Both functions do optimistic updates internally, so UI updates immediately
    Promise.allSettled([
        updateCard(updatedCard),
        submitReview(currentCard.id, quality, previousCard, durationMs)  // NEW: pass durationMs
    ]).then(results => {
        // Log failures but don't block UI
        results.forEach((result, idx) => {
            if (result.status === 'rejected') {
                const operation = idx === 0 ? 'updateCard' : 'submitReview';
                console.error(`${operation} failed:`, result.reason);
            }
        });
    }).finally(() => {
        setIsSubmittingResponse(false);
    });

    // Note: showAnswer reset handled by useEffect on currentCardId change
    // UI continues immediately - next card loads without waiting for DB
}, [currentCard, isSubmittingResponse, updateCard, submitReview, cardShowTime]);  // NEW: add cardShowTime to deps
```

Key points:
- Timer starts when card is displayed (via useEffect on currentCardId)
- Duration is calculated as `Date.now() - cardShowTime` when user rates
- Duration is passed as 4th parameter to submitReview
- This is "wall clock time" - includes time user spends away from tab (acceptable for MVP)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>StudySession tracks cardShowTime and passes durationMs to submitReview</done>
</task>

<task type="auto">
  <name>Task 2: Update submitReview to accept and save durationMs</name>
  <files>components/StoreContext.tsx</files>
  <action>
Update submitReview function in StoreContext.tsx to accept and store duration:

1. **Update function signature** (around line 1099):
```typescript
const submitReview = async (cardId: string, quality: number, previousCard: StudyCard, durationMs?: number) => {
```

2. **Update the StoreContextType interface** (around line 45):
```typescript
submitReview: (cardId: string, quality: number, previousCard: StudyCard, durationMs?: number) => Promise<void>;
```

3. **Include durationMs in newLog object** (around line 1136-1143):
```typescript
// Create review log (use previous card state for accurate logging)
const newLog = {
  id: generateUUID(),
  cardId,
  quality,
  reviewedAt: new Date().toISOString(),
  interval: previousCard.interval,
  easeFactor: previousCard.easeFactor,
  durationMs: durationMs || null  // NEW: Add duration to log
};
```

Key points:
- durationMs is optional for backward compatibility
- Use `durationMs || null` to ensure undefined becomes null for Supabase
- The toSupabaseReviewLog helper (updated in Plan 01) handles the conversion
- No changes needed to the Supabase insert call - it already uses toSupabaseReviewLog
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>submitReview accepts durationMs parameter and includes it in review log</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. App starts without errors: `npm run dev`
3. Manual test: Complete a review and check console for "DEBUG: Review Log Save" to see durationMs in newLog
</verification>

<success_criteria>
- StudySession has cardShowTime state
- Timer resets when currentCardId changes
- handleResponse calculates durationMs = Date.now() - cardShowTime
- submitReview accepts optional durationMs parameter
- Review log includes durationMs field when saved to Supabase
</success_criteria>

<output>
After completion, create `.planning/phases/13-dashboard-analytics/13-03-SUMMARY.md`
</output>
