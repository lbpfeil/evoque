---
phase: 02-component-migration
plan: 06
type: execute
wave: 3
depends_on: ["02-01"]
files_modified:
  - components/HighlightEditModal.tsx
  - components/HighlightHistoryModal.tsx
  - components/BookContextModal.tsx
autonomous: true

must_haves:
  truths:
    - "HighlightEditModal uses shadcn Dialog pattern"
    - "HighlightHistoryModal uses shadcn Dialog pattern"
    - "BookContextModal uses shadcn Dialog pattern"
    - "All content modals render correctly in both light and dark mode"
    - "Charts in modals adapt to theme (use CSS variables or computed styles)"
  artifacts:
    - path: "components/HighlightEditModal.tsx"
      provides: "Highlight editor with shadcn Dialog"
      contains: "DialogContent"
    - path: "components/HighlightHistoryModal.tsx"
      provides: "Learning curve modal with shadcn Dialog"
      contains: "DialogContent"
    - path: "components/BookContextModal.tsx"
      provides: "Book highlights modal with shadcn Dialog"
      contains: "DialogContent"
  key_links:
    - from: "components/HighlightEditModal.tsx"
      to: "components/ui/dialog"
      via: "import statement"
      pattern: "from.*ui/dialog"
---

<objective>
Migrate content modals (HighlightEditModal, HighlightHistoryModal, BookContextModal) to use shadcn Dialog pattern with semantic tokens.

Purpose: These modals display content rather than confirmations - they need Dialog (not AlertDialog). They also contain charts that need theme-aware colors.

Output: Three content modals using shadcn Dialog pattern with proper accessibility, theme support, and theme-aware charts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-component-migration/02-RESEARCH.md

# Modals to migrate
@components/HighlightEditModal.tsx
@components/HighlightHistoryModal.tsx
@components/BookContextModal.tsx

# Dialog component
@components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate BookContextModal to shadcn Dialog</name>
  <files>components/BookContextModal.tsx</files>
  <action>
  Replace the custom modal implementation with shadcn Dialog:

  ```tsx
  import React from 'react';
  import { useStore } from './StoreContext';
  import { BookOpen, Calendar, Hash } from 'lucide-react';
  import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
  } from './ui/dialog';

  interface BookContextModalProps {
    bookId: string | null;
    onClose: () => void;
  }

  const BookContextModal: React.FC<BookContextModalProps> = ({ bookId, onClose }) => {
    const { getBook, getBookHighlights } = useStore();

    if (!bookId) return null;

    const book = getBook(bookId);
    const bookHighlights = getBookHighlights(bookId);

    if (!book) return null;

    const formatDate = (dateString: string) => {
      try {
        return new Date(dateString).toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
        });
      } catch (e) {
        return dateString;
      }
    };

    return (
      <Dialog open={!!bookId} onOpenChange={(open) => !open && onClose()}>
        <DialogContent className="max-w-3xl max-h-[85vh] overflow-hidden flex flex-col p-0">
          {/* Header */}
          <DialogHeader className="p-6 border-b border-border flex-shrink-0">
            <div className="flex items-start gap-4">
              <img
                src={book.coverUrl}
                alt={book.title}
                className="w-24 h-36 object-cover rounded-sm shadow-md flex-shrink-0"
              />
              <div className="flex-1 min-w-0">
                <DialogTitle className="text-2xl font-bold mb-1 line-clamp-2">
                  {book.title}
                </DialogTitle>
                <p className="text-muted-foreground mb-3">{book.author}</p>

                <div className="flex flex-wrap gap-4 text-xs text-muted-foreground">
                  <div className="flex items-center gap-1.5">
                    <Calendar className="w-3.5 h-3.5" />
                    <span>Imported {formatDate(book.lastImported)}</span>
                  </div>
                  <div className="flex items-center gap-1.5">
                    <Hash className="w-3.5 h-3.5" />
                    <span>{bookHighlights.length} highlights</span>
                  </div>
                </div>
              </div>
            </div>
          </DialogHeader>

          {/* Highlights List */}
          <div className="flex-1 overflow-y-auto p-6 space-y-4">
            {bookHighlights.length === 0 ? (
              <div className="text-center py-12 text-muted-foreground">
                <BookOpen className="w-12 h-12 mx-auto mb-3 opacity-50" />
                <p>No highlights found for this book.</p>
              </div>
            ) : (
              bookHighlights.map((highlight, index) => (
                <div
                  key={highlight.id}
                  className="bg-muted border border-border rounded-md p-4 hover:border-primary/30 transition-colors duration-200"
                >
                  <div className="flex items-start gap-3">
                    <span className="text-xs font-bold text-muted-foreground mt-0.5">#{index + 1}</span>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-serif text-foreground leading-relaxed mb-2">
                        "{highlight.text}"
                      </p>
                      {highlight.note && (
                        <div className="bg-card border-l-2 border-foreground p-3 rounded-sm">
                          <span className="text-[10px] uppercase font-semibold text-muted-foreground block mb-1">My Note</span>
                          <p className="text-xs text-muted-foreground italic">{highlight.note}</p>
                        </div>
                      )}
                      <div className="flex items-center gap-3 mt-2 text-[10px] text-muted-foreground">
                        {highlight.location && <span>Location: {highlight.location}</span>}
                        {highlight.dateAdded && <span>â€¢ {formatDate(highlight.dateAdded)}</span>}
                      </div>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>

          {/* Footer */}
          <div className="p-4 border-t border-border bg-muted flex justify-end flex-shrink-0">
            <button
              onClick={onClose}
              className="px-6 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors duration-200 text-sm font-medium"
            >
              Close
            </button>
          </div>
        </DialogContent>
      </Dialog>
    );
  };

  export default BookContextModal;
  ```

  **Key changes:**
  - Import Dialog components from ui/dialog
  - Use `Dialog open={!!bookId}` for controlled open state
  - Use `DialogContent` with custom sizing and scroll handling
  - Replace all zinc-* with semantic tokens
  - Remove Portal import (Dialog handles portal)
  - Remove custom overlay (Dialog handles overlay)
  </action>
  <verify>
  - Run: `npm run build` (no errors)
  - Grep: `grep -c "zinc-" components/BookContextModal.tsx` returns 0
  - Grep: `grep "Dialog" components/BookContextModal.tsx` shows imports
  </verify>
  <done>
  - BookContextModal uses shadcn Dialog
  - Uses semantic tokens throughout
  - Preserves scrolling highlight list
  - Has proper accessibility
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate HighlightHistoryModal to shadcn Dialog with theme-aware charts</name>
  <files>components/HighlightHistoryModal.tsx</files>
  <action>
  Replace the implementation with shadcn Dialog and fix chart colors:

  ```tsx
  import React from 'react';
  import { TrendingUp } from 'lucide-react';
  import { useStore } from './StoreContext';
  import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
  import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
  } from './ui/dialog';

  interface HighlightHistoryModalProps {
    highlightId: string | null;
    onClose: () => void;
  }

  const HighlightHistoryModal: React.FC<HighlightHistoryModalProps> = ({ highlightId, onClose }) => {
    const { highlights, studyCards, reviewLogs } = useStore();

    if (!highlightId) return null;

    const highlight = highlights.find(h => h.id === highlightId);
    const card = studyCards.find(c => c.highlightId === highlightId);

    if (!highlight) return null;

    // Filter logs for this card
    const logs = reviewLogs.filter(l => l.cardId === card?.id).sort((a, b) => new Date(a.reviewedAt).getTime() - new Date(b.reviewedAt).getTime());

    // Prepare data
    const data = logs.map(log => ({
      date: new Date(log.reviewedAt).toLocaleDateString(),
      interval: log.interval,
      easeFactor: log.easeFactor
    }));

    // Add current state if available
    if (card && logs.length > 0) {
      data.push({
        date: 'Next',
        interval: card.interval,
        easeFactor: card.easeFactor
      });
    }

    return (
      <Dialog open={!!highlightId} onOpenChange={(open) => !open && onClose()}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-primary" />
              Learning Curve
            </DialogTitle>
          </DialogHeader>

          <div className="flex-1 overflow-y-auto space-y-6">
            <div>
              <p className="text-sm text-muted-foreground italic mb-2">
                "{highlight.text.substring(0, 100)}{highlight.text.length > 100 ? '...' : ''}"
              </p>
            </div>

            <div className="h-64 w-full">
              {data.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={data}>
                    <CartesianGrid strokeDasharray="3 3" className="stroke-border" />
                    <XAxis
                      dataKey="date"
                      className="text-muted-foreground"
                      tick={{ fill: 'currentColor', fontSize: 12 }}
                      stroke="currentColor"
                    />
                    <YAxis
                      className="text-muted-foreground"
                      tick={{ fill: 'currentColor', fontSize: 12 }}
                      stroke="currentColor"
                      label={{ value: 'Interval (days)', angle: -90, position: 'insideLeft', fill: 'currentColor' }}
                    />
                    <Tooltip
                      contentStyle={{
                        backgroundColor: 'hsl(var(--card))',
                        borderRadius: '0.5rem',
                        border: '1px solid hsl(var(--border))',
                        boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)',
                        color: 'hsl(var(--card-foreground))'
                      }}
                      itemStyle={{ color: 'hsl(var(--primary))', fontSize: '12px' }}
                    />
                    <Line
                      type="monotone"
                      dataKey="interval"
                      stroke="hsl(var(--primary))"
                      strokeWidth={2}
                      dot={{ r: 4, fill: 'hsl(var(--primary))' }}
                      activeDot={{ r: 6 }}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="flex items-center justify-center h-full text-muted-foreground text-sm">
                  No review history yet.
                </div>
              )}
            </div>

            <div className="grid grid-cols-3 gap-4">
              <div className="bg-muted p-3 rounded-md text-center">
                <p className="text-xs text-muted-foreground uppercase tracking-wider font-semibold">Repetitions</p>
                <p className="text-xl font-bold">{card?.repetitions || 0}</p>
              </div>
              <div className="bg-muted p-3 rounded-md text-center">
                <p className="text-xs text-muted-foreground uppercase tracking-wider font-semibold">Ease Factor</p>
                <p className="text-xl font-bold">{card?.easeFactor?.toFixed(2) || '-'}</p>
              </div>
              <div className="bg-muted p-3 rounded-md text-center">
                <p className="text-xs text-muted-foreground uppercase tracking-wider font-semibold">Next Review</p>
                <p className="text-xl font-bold">
                  {card ? new Date(card.nextReviewDate).toLocaleDateString() : '-'}
                </p>
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    );
  };

  export default HighlightHistoryModal;
  ```

  **Key changes:**
  - Import Dialog components
  - Use `Dialog open={!!highlightId}` for controlled state
  - Replace all zinc-* with semantic tokens
  - Chart colors use `hsl(var(--primary))` for theme awareness
  - Tooltip uses card/border CSS variables
  - CartesianGrid uses `className="stroke-border"`
  - Axes use `currentColor` for theme-aware text
  </action>
  <verify>
  - Run: `npm run build` (no errors)
  - Grep: `grep -c "zinc-\|#[0-9a-fA-F]" components/HighlightHistoryModal.tsx` returns 0 (no hardcoded colors)
  - Grep: `grep "Dialog" components/HighlightHistoryModal.tsx` shows imports
  </verify>
  <done>
  - HighlightHistoryModal uses shadcn Dialog
  - Uses semantic tokens throughout
  - Chart colors are theme-aware using CSS variables
  - Stats cards use semantic tokens
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate HighlightEditModal to shadcn Dialog with theme-aware charts</name>
  <files>components/HighlightEditModal.tsx</files>
  <action>
  This is the most complex modal. Update it to use Dialog while preserving all functionality:

  **1. Update imports (top of file):**
  ```tsx
  import React, { useState, useEffect } from 'react';
  import { useStore } from './StoreContext';
  import { BookOpen, Calendar, TrendingUp, ChevronDown, ChevronUp } from 'lucide-react';
  import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
  import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
  } from './ui/dialog';
  ```

  **2. Remove Portal import** (Dialog handles portal)

  **3. Replace the return statement's outer structure:**
  ```tsx
  // REPLACE the Portal wrapper and custom overlay
  return (
    <Dialog open={!!highlightId} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="max-w-2xl max-h-[95vh] overflow-hidden flex flex-col p-0">
        {/* Header with book info */}
        <DialogHeader className="p-3 border-b border-border flex-shrink-0">
          <div className="flex items-start gap-3">
            <img src={book.coverUrl} alt={book.title} className="w-14 h-[86px] object-cover rounded shadow-sm flex-shrink-0" />
            <div className="flex-1 min-w-0">
              <DialogTitle className="text-base font-bold mb-0.5 line-clamp-1">
                {book.title}
              </DialogTitle>
              <p className="text-xs text-muted-foreground mb-2">{book.author}</p>
              <div className="flex flex-wrap gap-3 text-[9px] text-muted-foreground">
                <div className="flex items-center gap-1">
                  <Calendar className="w-3 h-3" />
                  <span>{formatDate(highlight.dateAdded)}</span>
                </div>
                {highlight.location && (
                  <div className="flex items-center gap-1">
                    <BookOpen className="w-3 h-3" />
                    <span>{highlight.location}</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </DialogHeader>

        {/* Content area - scrollable */}
        <div className="flex-1 overflow-y-auto p-3 space-y-2">
          {/* Highlight text area */}
          <div className="bg-muted border border-border rounded p-2">
            <label className="text-[9px] uppercase text-muted-foreground font-semibold mb-1 block">Highlight</label>
            <textarea
              value={editForm.text}
              onChange={(e) => handleChange('text', e.target.value)}
              className="w-full bg-transparent border-0 px-0 py-0 text-xs font-serif text-foreground resize-none focus:outline-none placeholder:text-muted-foreground"
              rows={6}
            />
          </div>

          {/* Note text area */}
          <div className="bg-muted border border-border rounded p-2">
            <label className="text-[9px] uppercase text-muted-foreground font-semibold mb-1 block">Note</label>
            <textarea
              value={editForm.note}
              onChange={(e) => handleChange('note', e.target.value)}
              className="w-full bg-transparent border-0 px-0 py-0 text-xs font-serif text-foreground resize-none focus:outline-none placeholder:text-muted-foreground"
              rows={5}
              placeholder="Add a note..."
            />
          </div>

          {/* Stats toggle button */}
          {card && (
            <button
              onClick={() => setShowStats(!showStats)}
              className="w-full flex items-center justify-between p-2 rounded border border-border hover:bg-accent transition-colors duration-200 text-xs"
            >
              <span className="flex items-center gap-2 text-muted-foreground font-medium">
                <TrendingUp className="w-3 h-3" />
                Learning Stats
              </span>
              {showStats ? <ChevronUp className="w-3 h-3 text-muted-foreground" /> : <ChevronDown className="w-3 h-3 text-muted-foreground" />}
            </button>
          )}

          {/* Stats section (collapsible) */}
          {showStats && card && (
            <div className="space-y-3 pt-2">
              {/* Chart */}
              {statsData.length > 0 && (
                <div className="h-40 w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={statsData}>
                      <CartesianGrid strokeDasharray="3 3" className="stroke-border" />
                      <XAxis
                        dataKey="date"
                        tick={{ fill: 'currentColor', fontSize: 10 }}
                        stroke="currentColor"
                        className="text-muted-foreground"
                      />
                      <YAxis
                        tick={{ fill: 'currentColor', fontSize: 10 }}
                        stroke="currentColor"
                        className="text-muted-foreground"
                      />
                      <Tooltip
                        contentStyle={{
                          backgroundColor: 'hsl(var(--card))',
                          borderRadius: '0.375rem',
                          border: '1px solid hsl(var(--border))',
                          fontSize: '10px',
                          color: 'hsl(var(--card-foreground))'
                        }}
                        itemStyle={{ color: 'hsl(var(--primary))' }}
                      />
                      <Line
                        type="monotone"
                        dataKey="interval"
                        stroke="hsl(var(--primary))"
                        strokeWidth={2}
                        dot={{ r: 3, fill: 'hsl(var(--primary))' }}
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              )}

              {/* Stats grid */}
              <div className="grid grid-cols-3 gap-2">
                <div className="bg-muted p-2 rounded text-center">
                  <p className="text-[9px] text-muted-foreground uppercase font-semibold">Reps</p>
                  <p className="text-sm font-bold">{card.repetitions}</p>
                </div>
                <div className="bg-muted p-2 rounded text-center">
                  <p className="text-[9px] text-muted-foreground uppercase font-semibold">Ease</p>
                  <p className="text-sm font-bold">{card.easeFactor.toFixed(2)}</p>
                </div>
                <div className="bg-muted p-2 rounded text-center">
                  <p className="text-[9px] text-muted-foreground uppercase font-semibold">Interval</p>
                  <p className="text-sm font-bold">{card.interval}d</p>
                </div>
              </div>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
  ```

  **4. Remove the custom overlay handling code:**
  - Remove `handleOverlayMouseDown` function
  - Remove `handleOverlayClick` function
  - Dialog handles overlay clicks automatically via `onOpenChange`

  **5. Keep the ESC handler for auto-save:**
  The `handleClose` function is still needed for auto-save on close. Dialog's `onOpenChange` will call it.
  </action>
  <verify>
  - Run: `npm run build` (no errors)
  - Grep: `grep -c "zinc-\|#[0-9a-fA-F]" components/HighlightEditModal.tsx` returns 0
  - Grep: `grep "Dialog" components/HighlightEditModal.tsx` shows imports
  - Check: `grep -c "Portal" components/HighlightEditModal.tsx` returns 0 (Portal removed)
  </verify>
  <done>
  - HighlightEditModal uses shadcn Dialog
  - Auto-save on close preserved
  - Chart colors are theme-aware
  - All text areas and stats use semantic tokens
  - Collapsible stats section preserved
  </done>
</task>

</tasks>

<verification>
Run after all tasks complete:

```bash
# Verify no hardcoded colors
grep -rn "zinc-\|#[0-9a-fA-F]" components/BookContextModal.tsx components/HighlightHistoryModal.tsx components/HighlightEditModal.tsx

# Expected: No output (or minimal for Recharts internal defaults)

# Verify Dialog usage
grep -l "DialogContent" components/BookContextModal.tsx components/HighlightHistoryModal.tsx components/HighlightEditModal.tsx

# Expected: All three files listed

# Verify Portal removed from HighlightEditModal
grep -c "Portal" components/HighlightEditModal.tsx

# Expected: 0

# Build check
npm run build

# Visual verification
npm run dev
# Test BookContextModal: Click on a book in Dashboard
# Test HighlightHistoryModal: View history from Highlights page
# Test HighlightEditModal: Edit a highlight from Highlights page
# Toggle theme during each test - check chart colors adapt
```
</verification>

<success_criteria>
- BookContextModal uses shadcn Dialog
- HighlightHistoryModal uses shadcn Dialog with theme-aware charts
- HighlightEditModal uses shadcn Dialog with theme-aware charts and auto-save
- All modals render correctly in light and dark mode
- Charts use CSS variables for theme-aware colors
- No TypeScript errors on build
</success_criteria>

<output>
After completion, create `.planning/phases/02-component-migration/02-06-SUMMARY.md`
</output>
