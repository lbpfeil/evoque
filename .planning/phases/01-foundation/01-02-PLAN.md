---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - index.html
  - components/ThemeProvider.tsx
  - components/ThemeToggle.tsx
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between light and dark mode via UI control"
    - "Theme preference persists across browser sessions"
    - "App respects system preference on first visit"
    - "No flash of wrong theme on page load"
  artifacts:
    - path: "components/ThemeProvider.tsx"
      provides: "Theme context and useTheme hook"
      exports: ["ThemeProvider", "useTheme"]
    - path: "components/ThemeToggle.tsx"
      provides: "Theme toggle button component"
      exports: ["ThemeToggle"]
    - path: "index.html"
      provides: "Anti-FOUC script"
      contains: "evoque-theme"
    - path: "App.tsx"
      provides: "ThemeProvider integration"
      contains: "<ThemeProvider"
  key_links:
    - from: "components/ThemeToggle.tsx"
      to: "components/ThemeProvider.tsx"
      via: "useTheme hook"
      pattern: "useTheme\\(\\)"
    - from: "App.tsx"
      to: "components/ThemeProvider.tsx"
      via: "Provider wrapper"
      pattern: "<ThemeProvider"
    - from: "index.html"
      to: "localStorage"
      via: "Anti-FOUC script reading evoque-theme"
      pattern: "localStorage\\.getItem.*evoque-theme"
---

<objective>
Implement complete theme infrastructure: ThemeProvider with persistence, anti-FOUC script, and visible toggle control.

Purpose: Enable users to switch between light/dark themes with their preference persisting across sessions and respecting system settings on first visit.

Output: Working theme toggle that persists preference and prevents flash of wrong theme.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@App.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeProvider and useTheme hook</name>
  <files>components/ThemeProvider.tsx</files>
  <action>
Create a new file `components/ThemeProvider.tsx` with the following implementation:

```typescript
import { createContext, useContext, useEffect, useState } from "react"

type Theme = "dark" | "light" | "system"

type ThemeProviderProps = {
  children: React.ReactNode
  defaultTheme?: Theme
  storageKey?: string
}

type ThemeProviderState = {
  theme: Theme
  setTheme: (theme: Theme) => void
  resolvedTheme: "dark" | "light"
}

const ThemeProviderContext = createContext<ThemeProviderState | undefined>(undefined)

export function ThemeProvider({
  children,
  defaultTheme = "system",
  storageKey = "evoque-theme",
}: ThemeProviderProps) {
  const [theme, setThemeState] = useState<Theme>(() => {
    if (typeof window === "undefined") return defaultTheme
    return (localStorage.getItem(storageKey) as Theme) || defaultTheme
  })

  const [resolvedTheme, setResolvedTheme] = useState<"dark" | "light">(() => {
    if (typeof window === "undefined") return "light"
    if (theme === "system") {
      return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"
    }
    return theme
  })

  // Apply theme class to document
  useEffect(() => {
    const root = window.document.documentElement

    root.classList.remove("light", "dark")

    if (theme === "system") {
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light"
      root.classList.add(systemTheme)
      setResolvedTheme(systemTheme)
    } else {
      root.classList.add(theme)
      setResolvedTheme(theme)
    }
  }, [theme])

  // Listen for system preference changes
  useEffect(() => {
    if (theme !== "system") return

    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)")

    const handleChange = (e: MediaQueryListEvent) => {
      const newTheme = e.matches ? "dark" : "light"
      const root = window.document.documentElement
      root.classList.remove("light", "dark")
      root.classList.add(newTheme)
      setResolvedTheme(newTheme)
    }

    mediaQuery.addEventListener("change", handleChange)
    return () => mediaQuery.removeEventListener("change", handleChange)
  }, [theme])

  const setTheme = (newTheme: Theme) => {
    localStorage.setItem(storageKey, newTheme)
    setThemeState(newTheme)
  }

  return (
    <ThemeProviderContext.Provider value={{ theme, setTheme, resolvedTheme }}>
      {children}
    </ThemeProviderContext.Provider>
  )
}

export function useTheme() {
  const context = useContext(ThemeProviderContext)
  if (context === undefined) {
    throw new Error("useTheme must be used within a ThemeProvider")
  }
  return context
}
```

Key features:
- Supports "light", "dark", and "system" themes
- Persists to localStorage with key "evoque-theme"
- Listens for system preference changes when in "system" mode
- Exposes `resolvedTheme` for components that need to know actual applied theme
  </action>
  <verify>File exists and exports ThemeProvider and useTheme: `grep -E "export (function|const) (ThemeProvider|useTheme)" components/ThemeProvider.tsx`</verify>
  <done>ThemeProvider.tsx created with context, provider, and useTheme hook exported</done>
</task>

<task type="auto">
  <name>Task 2: Create ThemeToggle component and update index.html + App.tsx</name>
  <files>components/ThemeToggle.tsx, index.html, App.tsx</files>
  <action>
**Part A: Create ThemeToggle component**

Create `components/ThemeToggle.tsx`:

```typescript
import { Moon, Sun, Monitor } from "lucide-react"
import { useTheme } from "./ThemeProvider"

export function ThemeToggle() {
  const { theme, setTheme, resolvedTheme } = useTheme()

  const cycleTheme = () => {
    if (theme === "light") setTheme("dark")
    else if (theme === "dark") setTheme("system")
    else setTheme("light")
  }

  return (
    <button
      onClick={cycleTheme}
      className="inline-flex items-center justify-center rounded-lg p-2 text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
      title={`Current: ${theme} (${resolvedTheme}). Click to cycle.`}
    >
      {theme === "system" ? (
        <Monitor className="h-5 w-5" />
      ) : resolvedTheme === "dark" ? (
        <Moon className="h-5 w-5" />
      ) : (
        <Sun className="h-5 w-5" />
      )}
      <span className="sr-only">Toggle theme</span>
    </button>
  )
}
```

**Part B: Update index.html**

Replace the entire contents of index.html with:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#fafaf9" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1c1917" media="(prefers-color-scheme: dark)" />
    <title>Evoque</title>
    <script>
      // Anti-FOUC: Apply theme before React loads
      (function() {
        const storageKey = 'evoque-theme';
        const theme = localStorage.getItem(storageKey);

        if (theme === 'dark' ||
            (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ||
            (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.add('light');
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>
```

Changes from original:
- Removed CDN Tailwind script (Vite handles this)
- Removed Google Fonts link (using @fontsource-variable/inter in CSS)
- Removed hardcoded style block (conflicts with CSS variables)
- Added meta theme-color tags for mobile browser chrome
- Added anti-FOUC script that reads localStorage BEFORE React loads
- Updated title to "Evoque"

**Part C: Update App.tsx**

1. Add import at top: `import { ThemeProvider } from './components/ThemeProvider';`
2. Add import for ThemeToggle: `import { ThemeToggle } from './components/ThemeToggle';`
3. Wrap the app with ThemeProvider INSIDE ErrorBoundary but OUTSIDE AuthProvider:

```typescript
const App = () => {
  return (
    <ErrorBoundary>
      <ThemeProvider defaultTheme="system" storageKey="evoque-theme">
        <AuthProvider>
          <ProtectedApp />
        </AuthProvider>
      </ThemeProvider>
    </ErrorBoundary>
  );
};
```

4. Add ThemeToggle to the AppLayout, in a fixed position at bottom-right corner for now (Phase 2 will move it to Sidebar):

In AppLayout, after the main element, add:
```typescript
<div className="fixed bottom-4 right-4 z-50">
  <ThemeToggle />
</div>
```

Full AppLayout should look like:
```typescript
const AppLayout = ({ children }: React.PropsWithChildren) => {
  const location = useLocation();
  const isStudySession = location.pathname === '/study/session';

  return (
    <div className="min-h-screen bg-background flex text-foreground font-sans antialiased">
      {!isStudySession && <Sidebar />}
      <main className={`flex-1 ${!isStudySession ? 'md:ml-56 p-4 md:p-8' : ''} overflow-y-auto h-screen`}>
        {!isStudySession ? (
          <div className="max-w-6xl mx-auto">
            {children}
          </div>
        ) : (
          children
        )}
      </main>
      <div className="fixed bottom-4 right-4 z-50">
        <ThemeToggle />
      </div>
    </div>
  );
};
```

Note: Also change `bg-zinc-50` to `bg-background` and `text-zinc-900` to `text-foreground` in AppLayout.

5. In ProtectedApp's loading state, change hardcoded colors:
- `bg-zinc-50` -> `bg-background`
- `text-blue-600` -> `text-primary`
- `text-zinc-600` -> `text-muted-foreground`
  </action>
  <verify>
1. `test -f components/ThemeToggle.tsx && echo "ThemeToggle exists"`
2. `grep "evoque-theme" index.html` finds the anti-FOUC script
3. `grep "cdn.tailwindcss" index.html` returns nothing (CDN removed)
4. `grep "ThemeProvider" App.tsx` finds the import and usage
5. `grep "bg-background" App.tsx` confirms semantic colors used
  </verify>
  <done>
- ThemeToggle.tsx created with cycle functionality
- index.html cleaned up with anti-FOUC script
- App.tsx integrates ThemeProvider and shows toggle
- Hardcoded colors replaced with semantic tokens
  </done>
</task>

<task type="auto">
  <name>Task 3: Install additional shadcn components</name>
  <files>components/ui/*.tsx</files>
  <action>
Run the shadcn CLI to install the required components for Phase 2:

```bash
npx shadcn@latest add card tabs badge select checkbox switch tooltip scroll-area dropdown-menu -y
```

This installs:
- card: Flashcard display, settings panels
- tabs: Navigation between views
- badge: Tag display on highlights
- select: Book/tag filtering
- checkbox: Bulk selection, settings toggles
- switch: Feature toggles
- tooltip: Accessibility for icon buttons
- scroll-area: Custom scrollbars for highlight lists
- dropdown-menu: Actions menu (could be used for theme selector later)

The `-y` flag auto-accepts defaults.

After installation, verify the components use `@/lib/utils` import (not relative paths) - the shadcn CLI should handle this based on components.json config.
  </action>
  <verify>
Check that all components were installed:
```bash
ls components/ui/ | grep -E "(card|tabs|badge|select|checkbox|switch|tooltip|scroll-area|dropdown-menu)" | wc -l
```
Should return 9 (one file per component).
  </verify>
  <done>All 9 shadcn components installed in components/ui/</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm run dev` and open the app
2. Verify the theme toggle button appears (bottom-right corner)
3. Click toggle: light -> dark -> system -> light
4. Verify each mode shows correct colors
5. Refresh the page - theme should persist (no flash)
6. Open DevTools > Application > Local Storage - "evoque-theme" key should exist
7. Delete localStorage, set system to dark mode, refresh - should show dark
8. Verify no console errors
</verification>

<success_criteria>
- Theme toggle visible and cycles through light/dark/system
- Theme persists in localStorage under "evoque-theme"
- No flash of wrong theme on page load (anti-FOUC working)
- System preference detected on first visit
- All 9 shadcn components installed
- No hardcoded zinc-* or blue-* colors in App.tsx
- No CDN Tailwind script in index.html
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
